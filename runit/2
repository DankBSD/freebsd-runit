#!/bin/sh
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/rescue

. /usr/local/etc/runit/functions

detect_jail

runlevel=default
if [ -z "${JAILED}" ] && kenv -q runit.runlevel > /dev/null; then
	arg=$(kenv runit.runlevel)
	if [ -d /usr/local/etc/runit/runsvdir/"$arg" ]; then
		echo "Runlevel detected via kenv: '$arg'"
		runlevel="$arg"
	fi
elif [ -n "${RUNLEVEL}" ]; then
	if [ -d /usr/local/etc/runit/runsvdir/"${RUNLEVEL}" ]; then
		echo "Runlevel detected via environment: '${RUNLEVEL}'"
		runlevel="${RUNLEVEL}"
	fi
elif [ -d /usr/local/etc/runit/runsvdir/"$(hostname)" ]; then
	runlevel="$(hostname)"
	echo "Runlevel detected via host name: '${runlevel}'"
fi

[ -x /usr/local/etc/runit/local ] && /usr/local/etc/runit/local

runsvchdir "${runlevel}" || emergency_shell
ln -sF /usr/local/etc/runit/runsvdir/current /var/run/runit/runsvdir/current

/usr/sbin/utx boot

exec env - PATH=$PATH runsvdir -P /var/run/runit/runsvdir/current 'log: ...........................................................................................................................................................................................................................................................................................................................................................................................................'
